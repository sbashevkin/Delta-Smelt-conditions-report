---
title: "Water conditions report"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
require(sf)
require(rgdal)
require(raster)
require(tidyverse)
require(readxl)
require(ggthemes)
require(lubridate)
require(RColorBrewer)

insert_minor <- function(major_labs, n_minor) {labs <- 
                              c( sapply( major_labs, function(x) c(x, rep("", n_minor) ) ) )
                              labs[1:(length(labs)-n_minor)]}
```

#Download and load data

##Zooplankton
```{r}
#CB
if (!file.exists("Data/1972-2018CBMatrix.xlsx")) {
  download.file("ftp://ftp.wildlife.ca.gov/IEP_Zooplankton/1972-2018CBMatrix.xlsx", 
                "Data/1972-2018CBMatrix.xlsx", mode="wb")
}

#Mysid CPUE
if (!file.exists("Data/1972-2018MysidMatrix.xlsx")) {
  download.file("ftp://ftp.wildlife.ca.gov/IEP_Zooplankton/1972-2018MysidMatrix.xlsx", 
                "Data/1972-2018MysidMatrix.xlsx", mode="wb")
}

#Pump
if (!file.exists("Data/1972-2018Pump Matrix.xlsx")) {
  download.file("ftp://ftp.wildlife.ca.gov/IEP_Zooplankton/1972-2018Pump Matrix.xlsx", 
                "Data/1972-2018Pump Matrix.xlsx", mode="wb")
}

#Mysid BPUE
#if (!file.exists("Data/zoop_mysid_mass.csv")) {
#  download.file("https://raw.githubusercontent.com/InteragencyEcologicalProgram/Status-and-Trends/master/zoop_mysid_mass.csv", 
#                "zoop_mysid_mass.csv", mode="wb")
#}

#Zooplankton mass conversion
if (!file.exists("Data/zoop_individual_mass.csv")) {
  download.file("https://raw.githubusercontent.com/InteragencyEcologicalProgram/Status-and-Trends/master/zoop_individual_mass.csv", 
                "zoop_individual_mass.csv", mode="wb")
}

#EMP stations
if (!file.exists("Data/zoop_stations.csv")) {
  download.file("https://raw.githubusercontent.com/InteragencyEcologicalProgram/Status-and-Trends/master/zoop_stations.csv", 
                "zoop_stations.csv", mode="wb")
}
```


```{r}
#########**********Only including OTHCYCAD from CB because biomass indicates they're large, and only including small cyclopoids from pump sample******########
ZoopCB<-read_excel("Data/1972-2018CBMatrix.xlsx", 
                          sheet = "CB CPUE Matrix 1972-2018", 
                          col_types = c("numeric","numeric", "numeric", "numeric", "date", 
                                        "text", "text", "text", "numeric", "text", "text",
                                        "text", rep("numeric", 62)))%>%
  select(Date, Station, ACARTELA, ACARTIA, DIAPTOM, EURYTEM, OTHCALAD, PDIAPFOR, PDIAPMAR, SINOCAL, TORTANUS, AVERNAL, OTHCYCAD, BOSMINA, DAPHNIA, DIAPHAN, OTHCLADO)%>%
  gather(key="Taxa", value="CPUE", -Date, -Station)


ZoopPump<-read_excel("Data/1972-2018Pump Matrix.xlsx", 
                      sheet = " Pump CPUE Matrix 1972-2018", 
                      col_types = c("numeric","numeric", "numeric", "numeric", "date", 
                                    "text", "text", "text", "numeric", 
                                    "text", rep("numeric", 36)))%>%
  select(Date=SampleDate, Station, LIMNOSPP, LIMNOSINE, LIMNOTET, OITHDAV, OITHSIM, OITHSPP)%>%
  gather(key="Taxa", value="CPUE",-Date, -Station)



ZoopMysid<-read_excel("Data/EMPMysidBPUEMatrixAug2019.xlsx",
                      sheet="MysidBPUEMatrix1972-2018",
                    col_types = c(rep("numeric", 4), "date", "text", "text", "numeric", "numeric", "text", "text", rep("numeric", 16)))%>%
  #mutate(Date=parse_date_time(Date, orders="mdy"))%>%
  select(Date, Station, `Acanthomysis aspera`:`Unidentified mysid`)%>%
  mutate(Mysida=rowSums(select(., -Date, -Station), na.rm=T))%>%
  gather(key="Taxa", value="BPUE", -Date, -Station)%>%
  mutate(BPUE=BPUE*1000,
         Taxa="Mysida") # Convert to ug

Zoopmass<-read_csv("Data/zoop_individual_mass.csv", col_types = "cd")

Zoop<-bind_rows(ZoopCB, ZoopPump)%>%
  left_join(Zoopmass, by=c("Taxa"="taxon"))%>%
  mutate(BPUE=CPUE*mass_indiv_ug,
         Taxa=case_when(
           Taxa%in%c("ACARTELA", "ACARTIA", "DIAPTOM", "EURYTEM", "OTHCALAD", "PDIAPFOR", "PDIAPMAR", "SINOCAL", "TORTANUS") ~ "Calanoida",
           Taxa%in%c("AVERNAL", "LIMNOSPP", "LIMNOSINE", "LIMNOTET", "OITHDAV", "OITHSIM", "OITHSPP", "OTHCYCAD") ~ "Cyclopoida",
           Taxa%in%c("BOSMINA", "DAPHNIA", "DIAPHAN", "OTHCLADO") ~ "Cladocera"))%>%
  select(-CPUE, -mass_indiv_ug)%>%
  bind_rows(ZoopMysid)%>%
  mutate(Year=year(Date))
```

##Stations and regions
```{r}
Stations<-read_csv("Data/zoop_stations.csv",
                   col_types = "cdcdddddddd")%>%
  mutate(Latitude=lat_deg+lat_min/60+lat_sec/3600,
         Longitude=(long_deg+long_min/60+long_sec/3600)*(-1))%>%
  select(Station=station, Latitude, Longitude)%>%
  drop_na()

#Load delta regions shapefile from Morgan
Deltaregions<-st_read("Data/Delta regions")
Deltaregions<-as(Deltaregions, "Spatial")

#Match each unique region from zoop dataset to a region from the shapefile
Locations<-Stations
coordinates(Locations) <- ~Longitude+Latitude
proj4string(Locations) <- CRS("+proj=longlat +datum=NAD83")
Locations <- spTransform(Locations, proj4string(Deltaregions))
Locations<-Locations %over% Deltaregions
Stations<-Stations%>%
  bind_cols(Locations%>%
              dplyr::select(Region=Stratum))%>%
  mutate(Region=replace_na(as.character(Region), "San Pablo Bay"))

#Add regions and lat/long to zoop dataset
Zoopsum<-Zoop%>%
  left_join(Stations, by="Station")%>%
  filter(!is.na(Region))%>% 
  group_by(Region, Year, Taxa)%>%
  summarise(BPUE=mean(BPUE, na.rm=T))%>%
  ungroup()
```


#Plot

##Mysids

```{r}
Zoopsum%>%
  filter(Year>1991, Taxa%in%c("A_aspera", "A_hwanhaiensis", "A_macropsis", "D_holmquistae", "H_longirostris", "N_kadiakensis", "N_mercedis"))%>%
  ggplot(aes(x=Year, y=CPUE, fill=Taxa))+
  geom_area()+
  scale_x_continuous(labels=insert_minor(seq(1990, 2020, by=5), 4), breaks = 1990:2020)+
  facet_wrap(~Region)+
  theme_bw()+
  theme(panel.grid=element_blank(), strip.background = element_blank())
```

##Calanoids

```{r}
Zoopsum%>%
  filter(Year>1991, Taxa%in%c("A_sinensis", "Acartia_spp.", "Diaptomidae_spp.", "E_affinis", "Calanoida_spp.", "P_forbesi", "P_marinus", "S_doerrii", "Tortanus_spp."))%>%
  ggplot(aes(x=Year, y=CPUE, fill=Taxa))+
  geom_area()+
  scale_x_continuous(labels=insert_minor(seq(1990, 2020, by=5), 4), breaks = 1990:2020)+
  coord_cartesian(expand=0)+
  facet_wrap(~Region)+
  theme_bw()+
  theme(panel.grid=element_blank(), strip.background = element_blank())
```

##Cyclopoids

```{r}
Zoopsum%>%
  filter(Year>1991, Taxa%in%c("A_vernalis", "Limnoithona"))%>%
  ggplot(aes(x=Year, y=CPUE, fill=Taxa))+
  geom_area()+
  scale_x_continuous(labels=insert_minor(seq(1990, 2020, by=5), 4), breaks = 1990:2020)+
  coord_cartesian(expand=0)+
  facet_wrap(~Region)+
  theme_bw()+
  theme(panel.grid=element_blank(), strip.background = element_blank())
```

##Cladocerans

```{r}
Zoopsum%>%
  filter(Year>1991, Taxa%in%c("B_longirostris", "Daphnia_spp.", "Diaphanosoma_spp.", "Cladocera_spp."))%>%
  ggplot(aes(x=Year, y=CPUE, fill=Taxa))+
  geom_area()+
  scale_x_continuous(labels=insert_minor(seq(1990, 2020, by=5), 4), breaks = 1990:2020)+
  coord_cartesian(expand=0)+
  facet_wrap(~Region)+
  theme_bw()+
  theme(panel.grid=element_blank(), strip.background = element_blank())
```

##Major groups
```{r}
Zoopsum%>%
  filter(Year>1991)%>%
  mutate(Taxa=factor(Taxa, levels=c("Calanoida", "Cyclopoida", "Cladocera", "Mysida")))%>%
  ggplot(aes(x=Year, y=BPUE, fill=Taxa))+
  geom_area()+
  scale_x_continuous(labels=insert_minor(seq(1990, 2020, by=5), 4), breaks = 1990:2020)+
  scale_fill_manual(values=brewer.pal(4, "BrBG"))+
  coord_cartesian(expand=0)+
  facet_wrap(~Region)+
  theme_bw()+
  theme(panel.grid=element_blank(), strip.background = element_blank())
```


#Old CPUE code
```{r}
ZoopCB<-read_excel("Data/1972-2018CBMatrix.xlsx", 
                          sheet = "CB CPUE Matrix 1972-2018", 
                          col_types = c("numeric","numeric", "numeric", "numeric", "date", 
                                        "text", "text", "text", "numeric", "text", "text",
                                        "text", rep("numeric", 62)))%>%
  select(Volume=CBVolume, Year, Date, Station, A_sinensis=ACARTELA, Acartia_spp.=ACARTIA, Diaptomidae_spp.=DIAPTOM, E_affinis=EURYTEM, Calanoida_spp.=OTHCALAD, P_forbesi=PDIAPFOR, P_marinus=PDIAPMAR, S_doerrii=SINOCAL, Tortanus_spp.=TORTANUS, Calanoida=ALLCALADULTS, Cyclopoida=AVERNAL, B_longirostris=BOSMINA, Daphnia_spp.=DAPHNIA, Diaphanosoma_spp.=DIAPHAN, Cladocera_spp.=OTHCLADO, Cladocera=ALLCLADOCERA)%>%
  gather(key="Taxa", value="CPUE", -Volume, -Year, -Date, -Station)


ZoopMysid<-read_excel("Data/1972-2018MysidMatrix.xlsx", 
                          sheet = "Mysid CPUE Matrix 1972-2018 ", 
                          col_types = c(rep("numeric", 4), "date", rep("text", 3), 
                                        "numeric", "text", rep("numeric", 14)))%>%
  select(Date=SampleDate, Volume=MysidVolume, Year, Station, A_aspera=`A_ aspera`, A_hwanhaiensis=`A_ hwanhaiensis`, A_macropsis=`A_ macropsis`, D_holmquistae=`D_ holmquistae`, H_longirostris=`H_ longirostris`, N_kadiakensis=`N_ kadiakensis`, N_mercedis=`N_ mercedis`, UnID_mysid=`Unidentified mysid`)%>%
  mutate(Mysida=rowSums(select(., A_aspera:UnID_mysid), na.rm=T))%>%
  gather(key="Taxa", value="CPUE", -Volume, -Year, -Date, -Station)


ZoopPump<-read_excel("Data/1972-2018Pump Matrix.xlsx", 
                      sheet = " Pump CPUE Matrix 1972-2018", 
                      col_types = c("numeric","numeric", "numeric", "numeric", "date", 
                                    "text", "text", "text", "numeric", 
                                    "text", rep("numeric", 36)))%>%
  select(Date=SampleDate, Volume=PumpVolume, Year, Station, Cyclopoida=ALLCYCADULTS)%>%
  gather(key="Taxa", value="CPUE", -Volume, -Year, -Date, -Station)
```

